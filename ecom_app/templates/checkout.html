{% extends 'base.html' %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/checkout.css' %}">
{% block body %}
<!DOCTYPE html>
<html>

<head>
    <title>Checkout Form</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
</head>

<body>
    <form method="post" id="razorpay-form" action="{% url 'ecom_app:create_order' %}" novalidate>
        {% csrf_token %}
        <div class="col-md-4 container bg-default">
            <h4 class="my-4">Billing Address</h4>
            <div class="form-row">
                <div class="col-md-6 form-group">
					<label for="firstname">First Name</label>
					<input type="text" class="form-control" id="firstname" placeholder="First Name" 
						   required pattern="[A-Za-z]+" title="Please enter a valid first name (letters only)." name="name">
					<div class="invalid-feedback">Valid first name is required.</div>
				</div>
				

                <div class="col-md-6 form-group">
					<label for="firstname">Last Name</label>
					<input type="text" class="form-control" id="firstname" placeholder="Last Name" 
						   required pattern="[A-Za-z]+" title="Please enter a valid first name (letters only)." name="lname">
					<div class="invalid-feedback">Valid Last name is required.</div>
				</div>
            </div>

            <div class="form-group">
                <label for="username">Username</label>
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text">@</span>
                    </div>
                    <input type="text" class="form-control" id="username" placeholder="Username" required>
                    <div class="invalid-feedback">Your username is required.</div>
                </div>
            </div>

            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" class="form-control" id="email" placeholder="you@example.com" required>
                <div class="invalid-feedback">Please enter a valid email address.</div>
            </div>

            <div class="form-group">
                <label for="address">Address</label>
                <input type="text" class="form-control" id="address" placeholder="1234 Main Street" required>
                <div class="invalid-feedback">Please enter your shipping address.</div>
            </div>

            <div class="form-group">
                <label for="address2">Address 2 <span class="text-muted">(Optional)</span></label>
                <input type="text" class="form-control" id="address2" placeholder="Flat No">
            </div>

            <div class="row">
                <div class="col-md-4 form-group">
                    <label for="country">Country</label>
                    <select class="form-control" id="country" required>
                        <option value="">Choose..</option>
                        <option value="India">India</option>
                        <option value="United Kingdom">United Kingdom</option>
                        <option value="Australia">Australia</option>
                    </select>
                    <div class="invalid-feedback">Please select a valid country.</div>
                </div>

                <div class="col-md-4 form-group">
                    <label for="city">City</label>
                    <select class="form-control" id="city" required>
                        <option value="">Choose..</option>
                        <option value="Thane">Thane</option>
                        <option value="Bhiwandi">Bhiwandi</option>
                        <option value="Badlapur">Badlapur</option>
                        <option value="Badlapur">Nagpur</option>
                    </select>
                    <div class="invalid-feedback">Please provide a valid city.</div>
                </div>

                <div class="col-md-4 form-group">
                    <label for="postcode">Postcode</label>
                    <input type="text" class="form-control" id="postcode" placeholder="Postcode" pattern="\d{6}" required>
                    <div class="invalid-feedback">Please enter a valid postcode (6 digits).</div>
                </div>
            </div>

            <hr>

            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="shipping-address" value="true">
                <label for="shipping-address" class="form-check-label">Shipping address is the same as my billing address</label>
            </div>

            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="same-address" value="true">
                <label for="same-address" class="form-check-label">Save this information for next time</label>
            </div>

            <hr>

            <button class="btn btn-primary btn-lg btn-block" type="submit">Proceed to Payment</button>
        </div>
    </form>

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
        // Example of custom validation handling
        document.getElementById('razorpay-form').addEventListener('submit', function (e) {
            e.preventDefault();
            if (this.checkValidity() === false) {
                e.stopPropagation();
            } else {
                fetch('{% url "ecom_app:create_order" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({}) // Ensure you send any required data here
                })
                .then(response => response.json())
                .then(data => {
                    var options = {
                        key: "{{ RAZORPAY_KEY_ID }}", // Your Razorpay key
                        amount: data.amount, // Amount is in paise
                        currency: "INR",
                        name: "sabse_sasta",
                        order_id: data.id, // Use the id returned from the create_order function
                        handler: function (response) {
                            // Redirect to success page after successful payment
                            window.location.href = "{% url 'ecom_app:payment_success' %}";
                        },
                        prefill: {
                            name: "Customer Name",
                            email: "ksamant726@gmail.com",  //rajeshvtutor@gmail.com
                            contact: "7666980874"  //7303399629
                        },
                        theme: {
                            color: "#F37254"
                        }
                    };

                    var razorpay = new Razorpay(options);
                    razorpay.open();
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            }
            this.classList.add('was-validated');
        }, false);
    </script>
</body>

</html>
{% endblock %}
